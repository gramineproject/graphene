# This makefile should be used to generate Dockerfiles for all prebuilt images. Prebuilt images are
# located in images/*. These files are then pulled by Docker Hub to generate the public Docker Hub
# images of Graphene and cannot be generated by Docker Hub, since it does not execute commands. When
# GSC changes substantially in its initial Graphene build (e.g. when
# template/Dockerfile.*.compile.template changes), these automatically generated files need to be
# updated. Generally, changes to Graphene do not require rebuilding these Docker files.

IMAGES=aks
VERSIONS=latest
REPOSITORY_NAME=graphenelibos

all: generate-dockerfiles build-images

config.aks.%.yaml:
	printf \
	"Distro: \"ubuntu18.04\"\n\
	Graphene:\n\
	    Repository: \"https://github.com/oscarlab/graphene.git\"\n\
	    Branch: \"$*\"\n\
	SGXDriver:\n\
	    Repository: \"https://github.com/intel/SGXDataCenterAttestationPrimitives.git\"\n\
	    Branch: \"DCAP_1.7 && cp -r driver/linux/* .\"\n" > $@

images/graphene_aks.latest.dockerfile: config.aks.master.yaml
	./gsc build-graphene -f -c $< graphene-aks
	mv graphene-aks/Dockerfile.compile $@
	$(RM) -r graphene-aks

.PHONY: generate-dockerfiles
generate-dockerfiles: $(addsuffix .dockerfile, $(addprefix $(addprefix images/, graphene_${IMAGES}), .${VERSIONS}))

.PHONY: build-images
build-images: $(addprefix $(addprefix build-, $(IMAGES))-, $(VERSIONS))

.PHONY: build-aks-%
build-aks-%: images/graphene_aks.%.dockerfile
	docker build --rm --no-cache -t $(REPOSITORY_NAME)/aks:$* -f images/graphene_aks.$*.dockerfile images/

.PHONY: push-images
push-images: $(addprefix $(addprefix push-, $(IMAGES))-, $(VERSIONS))

.PHONY: push-aks-%
push-aks-%:
	docker push $(REPOSITORY_NAME)/aks:$*

.PHONY: distclean
distclean: clean-images
	$(RM) -r images/

.PHONY: clean
clean:
	$(RM) config.aks.*.yaml

.PHONY: clean-images
clean-images:
	docker rmi -f $(addprefix $(addprefix $(REPOSITORY_NAME)/, $(IMAGES)):, $(VERSIONS))
