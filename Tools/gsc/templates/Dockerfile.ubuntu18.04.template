FROM ubuntu:18.04 AS graphene

# Add steps here to set up dependencies
RUN env DEBIAN_FRONTEND=noninteractive apt-get update \
    && env DEBIAN_FRONTEND=noninteractive apt-get install -y \
        autoconf \
        bison \
        build-essential \
        coreutils \
        gawk \
        git \
        libcurl4-openssl-dev \
        libprotobuf-c-dev \
        protobuf-c-compiler \
        python3-protobuf \
        wget

# Clone graphene
RUN git clone {{Graphene.Repository}} /graphene

# Init submodules
RUN cd /graphene \
    && git fetch origin {{Graphene.Branch}} \
    && git checkout {{Graphene.Branch}} \
    && git submodule update --init -- Pal/src/host/Linux-SGX/sgx-driver/

# Create keys for signing
RUN cd /graphene/Pal/src/host/Linux-SGX/signer/ && openssl genrsa -3 -out enclave-key.pem 3072

# Create SGX driver for header files
RUN cd /graphene/Pal/src/host/Linux-SGX/sgx-driver \
    && git clone {{SGXDriver.Repository}} linux-sgx-driver \
    && cd linux-sgx-driver \
    && git checkout {{SGXDriver.Branch}}

# Build Graphene-SGX
RUN cd /graphene && ISGX_DRIVER_PATH=/graphene/Pal/src/host/Linux-SGX/sgx-driver/linux-sgx-driver \
    make -s -j4 SGX=1 {% if args.debug %} DEBUG=1 {% endif %} WERROR=1 {% if args.Linux %} \
     && make WERROR=1 {% if args.debug %} DEBUG=1 {% endif %} {% endif %}

# Translate runtime symlinks to files
RUN for f in $(find /graphene/Runtime -type l);do cp --remove-destination $(readlink $f) $f;done;

# Finished building Graphene

{% if not args.graphene %}

# Integrate Graphene into the app image
# This file is used in a multistage docker build process, in which the previous image is named "graphene"
FROM {{app_image}}

# Update any packages
RUN apt-get update \
    && env DEBIAN_FRONTEND=noninteractive apt-get install -y \
        python3 \
        python3-pip \
        python3-protobuf \
        libprotobuf-c-dev \
        binutils \
        openssl \
    && python3 -m pip install protobuf jinja2

{% if args.debug %}
# Install GDB and related tools when Debug is enabled
RUN env DEBIAN_FRONTEND=noninteractive apt-get install -y \
        gdb \
        less \
        strace \
        vim
{% endif %}

# Copy Graphene runtime and signer tools to /graphene
RUN mkdir -p /graphene \
    && mkdir -p /graphene/Runtime \
    && mkdir -p /graphene/signer \
    && mkdir -p /graphene/Pal/src
COPY --from=graphene /graphene/Runtime/ /graphene/Runtime
COPY --from=graphene /graphene/Pal/src/host/Linux-SGX/signer/ /graphene/signer
COPY --from=graphene /graphene/Pal/src/host/Linux-SGX/generated_offsets.py /graphene/signer/
{% if args.debug %}
COPY --from=graphene /graphene/Pal/src/host/Linux-SGX/debugger/sgx_gdb.so /graphene/Runtime
COPY --from=graphene /graphene/Pal/src/host/Linux-SGX/debugger/pal-gdb.py /graphene/Runtime
{% endif %}

# Copy template scripts and manifests
COPY apploader.sh ./
COPY *.manifest ./
COPY finalize_manifests.py /

# Mark apploader.sh executable, finalize manifests, and remove intermediate scripts
RUN chmod u+x apploader.sh \
    && python3 /finalize_manifests.py / {{binary}}.manifest {{user_manifests}} \
    && rm -f /finalize_manifests.py

# Define default command
ENTRYPOINT  ["/bin/sh", "./apploader.sh"]
CMD [{{cmd}}]

{% endif %}
