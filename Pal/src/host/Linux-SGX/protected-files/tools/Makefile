include ../../../../../../Scripts/Makefile.configs

CFLAGS := -Wall -Wextra -O2 -maes -std=c11 \
	-fno-omit-frame-pointer \
	-I../../../../../include/lib \
	-I../../../../../lib/crypto/mbedtls/install/include \
	-D_GNU_SOURCE

LDFLAGS += -L../../../../../lib/crypto/mbedtls/install/lib

ifeq ($(DEBUG),1)
CC += -gdwarf-2 -g3
CFLAGS += -DDEBUG
export DEBUG
endif

ifeq ($(WERROR),1)
CFLAGS += -Werror
endif

headers = $(wildcard *.h) ../protected_files.h ../lru_cache.h
objs = util pf_util pf_crypt
#bins = pf_crypt pf_tamper
bins = pf_crypt

.PHONY: all
all: $(bins)

protected_files.o: ../protected_files.c
	$(CC) $(CFLAGS) $(CFLAGS-$@) -c -o $@ $<

lruc.o: ../lru_cache.c
	$(CC) $(CFLAGS) $(CFLAGS-$@) -c -o $@ $<

$(addsuffix .o,$(objs)): %.o: %.c $(headers)
	$(CC) $(CFLAGS) $(CFLAGS-$@) -c -o $@ $<

pf_crypt: pf_crypt.o util.o pf_util.o protected_files.o lruc.o
	@echo [ host/Linux-SGX/tools/$@ ]
	@$(CC) $(CFLAGS) $(LDFLAGS) -Wl,-z,relro,-z,now $^ -lc -lmbedcrypto -o $@

#pf_tamper: pf_tamper.o util.o pf_util.o protected_files.o lruc.o
#	@echo [ host/Linux-SGX/tools/$@ ]
#	@$(CC) $(CFLAGS) -Wl,-z,relro,-z,now $^ -lc -lmbedcrypto -o $@

clean:
	@rm -f *.o
	@rm -f $(bins)
