pipeline {
        agent {
            dockerfile { filename 'Jenkinsfiles/ubuntu-16.04.dockerfile'
 	                 label 'sgx_slave'
	    	       }	    
        }
        stages {
                stage('Build') {
                    steps {
                        sh '''
                            cd Pal/src/host/Linux-SGX/signer/ && openssl genrsa -3 -out enclave-key.pem 3072
			    pwd
			    ls -la ~/
                            cd Pal/src/host/Linux-SGX/sgx-driver && make
			    make SGX=1
			    make SGX_RUN=1
                        '''
                    }
                }
                stage('Test') {
                    steps {
                        sh '''
                            cd LibOS/shim/test/apps/python
                            ls
                            make SGX=1
                            make SGX_RUN=1
                            ls
                            ./python.manifest scripts/helloworld.py
                            ./python.manifest scripts/fibonacci.py
                        '''
                    }
                }
                stage('Deploy') {
                    steps {
                        sh 'echo Deploying code'
                    }
                }
        }
        post {
                success {
                        echo 'Deployment successful'
                }
                failure {
                        echo 'Failure while on the pipeline'
                }
                unstable {
                        echo 'Pipeline marked as "unstable"'
                }
        }
}
